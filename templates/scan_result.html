{% extends "base.html" %}

{% block title %}WASSp - Scan Results{% endblock %}

{% block content %}
<div class="container main-container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-clipboard-check text-primary"></i> Scan Results
            </h1>
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> Scan completed successfully for <strong>{{ scan_results.url }}</strong>
                <div class="small mt-1">Scan timestamp: {{ scan_results.timestamp }}</div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0"><i class="fas fa-info-circle"></i> Scan Summary</h3>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tr>
                            <th>Target URL:</th>
                            <td>{{ scan_results.url }}</td>
                        </tr>
                        <tr>
                            <th>Scan Type:</th>
                            <td>
                                {% if scan_results.scan_type == 'basic' %}
                                    <span class="badge bg-success">Basic</span>
                                {% elif scan_results.scan_type == 'full' %}
                                    <span class="badge bg-warning">Full</span>
                                {% else %}
                                    <span class="badge bg-danger">Advanced</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>URLs Scanned:</th>
                            <td>{{ scan_results.target_urls|length }}</td>
                        </tr>
                        <tr>
                            <th>Vulnerabilities Found:</th>
                            <td>
                                {% set vuln_count = namespace(total=0) %}
                                {% for url, result in scan_results.results.items() %}
                                    {% if result.vulnerabilities %}
                                        {% set vuln_count.total = vuln_count.total + result.vulnerabilities|length %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if vuln_count.total > 0 %}
                                    <span class="badge bg-danger">{{ vuln_count.total }}</span>
                                {% else %}
                                    <span class="badge bg-success">0</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0"><i class="fas fa-download"></i> Export Report</h3>
                </div>
                <div class="card-body">
                    <p>Download the scan results in your preferred format:</p>
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('export_scan_results', format='pdf') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <a href="{{ url_for('export_scan_results', format='html') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-file-code"></i> HTML
                        </a>
                        <a href="{{ url_for('export_scan_results', format='json') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-file-alt"></i> JSON
                        </a>
                        <a href="{{ url_for('export_scan_results', format='csv') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                        <a href="{{ url_for('export_scan_results', format='sarif') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-code"></i> SARIF
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0"><i class="fas fa-chart-bar"></i> Security Overview</h3>
                </div>
                <div class="card-body">
                    <canvas id="securityChart" height="200"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0"><i class="fas fa-robot"></i> AI Analysis</h3>
                    {% if scan_results.get('ai_analysis') %}
                        <span class="badge bg-success">Available</span>
                    {% else %}
                        <button class="btn btn-sm btn-outline-light" id="runAiAnalysis">
                            <i class="fas fa-brain"></i> Analyze Vulnerabilities
                        </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if scan_results.get('ai_analysis') %}
                        <div class="ai-analysis-result">
                            {{ scan_results.ai_analysis.analysis|safe|linebreaksbr }}
                        </div>
                    {% else %}
                        <div class="text-center" id="aiFeatureInfo">
                            <div class="py-4">
                                <i class="fas fa-robot feature-icon"></i>
                                <h4>AI-Powered Vulnerability Analysis</h4>
                                <p>Get detailed remediation advice for detected vulnerabilities using OpenAI's GPT models.</p>
                                <p class="text-muted small mb-3">This feature requires an OpenAI API Key</p>
                                <button class="btn btn-primary" id="enableAiButton">
                                    <i class="fas fa-brain"></i> Enable AI Analysis
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center d-none" id="aiAnalysisLoading">
                            <div class="py-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h4 class="mt-3">Analyzing Vulnerabilities...</h4>
                                <p class="text-muted">The AI is analyzing your scan results and generating detailed remediation advice.</p>
                            </div>
                        </div>
                        
                        <div id="aiAnalysisResult" class="d-none">
                            <!-- This will be populated with the AI analysis -->
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Vulnerabilities</h3>
                </div>
                <div class="card-body">
                    {% set found_vulnerabilities = false %}
                    {% for url, result in scan_results.results.items() %}
                        {% if result.vulnerabilities %}
                            {% set found_vulnerabilities = true %}
                            <div class="result-item mb-4">
                                <h5>{{ url }}</h5>
                                <ul class="list-group">
                                    {% for vuln in result.vulnerabilities %}
                                        <li class="list-group-item">
                                            <div class="d-flex justify-content-between">
                                                <strong>{{ vuln.type }}</strong>
                                                <span class="severity-{{ vuln.severity|lower }}">{{ vuln.severity }}</span>
                                            </div>
                                            <p class="mb-1">{{ vuln.description }}</p>
                                            {% if vuln.url %}
                                                <small class="text-muted">URL: {{ vuln.url }}</small>
                                            {% endif %}
                                            {% if vuln.cookie %}
                                                <small class="text-muted">Cookie: {{ vuln.cookie }}</small>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    {% endfor %}
                    
                    {% if not found_vulnerabilities %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle feature-icon text-success"></i>
                            <h4>No Vulnerabilities Detected</h4>
                            <p>Great job! We didn't find any vulnerabilities with our basic checks. However, this doesn't guarantee your site is 100% secure.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <ul class="nav nav-tabs mb-4" id="resultTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="dns-tab" data-bs-toggle="tab" data-bs-target="#dns" type="button" role="tab">
                <i class="fas fa-network-wired"></i> DNS Records
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ssl-tab" data-bs-toggle="tab" data-bs-target="#ssl" type="button" role="tab">
                <i class="fas fa-lock"></i> SSL Certificate
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="headers-tab" data-bs-toggle="tab" data-bs-target="#headers" type="button" role="tab">
                <i class="fas fa-code"></i> HTTP Headers
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content" type="button" role="tab">
                <i class="fas fa-file-alt"></i> Content Info
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tech-tab" data-bs-toggle="tab" data-bs-target="#tech" type="button" role="tab">
                <i class="fas fa-microchip"></i> Technology Stack
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cookies-tab" data-bs-toggle="tab" data-bs-target="#cookies" type="button" role="tab">
                <i class="fas fa-cookie-bite"></i> Cookies
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab">
                <i class="fas fa-plug"></i> API Security
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="whois-tab" data-bs-toggle="tab" data-bs-target="#whois" type="button" role="tab">
                <i class="fas fa-id-card"></i> WHOIS
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ip-tab" data-bs-toggle="tab" data-bs-target="#ip" type="button" role="tab">
                <i class="fas fa-shield-alt"></i> IP Quality
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="resultTabsContent">
        <div class="tab-pane fade show active" id="dns" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    {% set main_result = scan_results.results[scan_results.url] %}
                    {% if main_result.dns_records %}
                        <h4 class="mb-3">DNS Records for {{ scan_results.url }}</h4>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Record Type</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record_type, records in main_result.dns_records.items() %}
                                        <tr>
                                            <td><strong>{{ record_type }}</strong></td>
                                            <td>
                                                {% if records is string %}
                                                    {{ records }}
                                                {% else %}
                                                    <ul class="list-unstyled mb-0">
                                                        {% for record in records %}
                                                            <li>{{ record }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> DNS records information not available.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="ssl" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    {% set main_result = scan_results.results[scan_results.url] %}
                    {% if main_result.ssl_info and not main_result.ssl_info.get('error') %}
                        <h4 class="mb-3">SSL Certificate Information</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Certificate Details</h5>
                                <table class="table table-striped">
                                    <tr>
                                        <th>Common Name</th>
                                        <td>{{ main_result.ssl_info.subject.get('CN', 'N/A') }}</td>
                                    </tr>
                                    <tr>
                                        <th>Issuer</th>
                                        <td>{{ main_result.ssl_info.issuer.get('CN', 'N/A') }}</td>
                                    </tr>
                                    <tr>
                                        <th>Valid From</th>
                                        <td>{{ main_result.ssl_info.not_before }}</td>
                                    </tr>
                                    <tr>
                                        <th>Valid Until</th>
                                        <td>{{ main_result.ssl_info.not_after }}</td>
                                    </tr>
                                    <tr>
                                        <th>Expired</th>
                                        <td>
                                            {% if main_result.ssl_info.has_expired %}
                                                <span class="badge bg-danger">Yes</span>
                                            {% else %}
                                                <span class="badge bg-success">No</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5>Certificate Subject</h5>
                                <table class="table table-striped">
                                    {% for key, value in main_result.ssl_info.subject.items() %}
                                        <tr>
                                            <th>{{ key }}</th>
                                            <td>{{ value }}</td>
                                        </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> SSL information not available. This might be an HTTP site or there was an error retrieving certificate information.
                            {% if main_result.ssl_info and main_result.ssl_info.get('error') %}
                                <p class="mb-0 mt-2">Error: {{ main_result.ssl_info.error }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="headers" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    {% set main_result = scan_results.results[scan_results.url] %}
                    {% if main_result.headers and not main_result.headers.get('error') %}
                        <h4 class="mb-3">HTTP Headers</h4>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Header</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for header, value in main_result.headers.items() %}
                                        <tr>
                                            <td><strong>{{ header }}</strong></td>
                                            <td>{{ value }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> HTTP headers information not available.
                            {% if main_result.headers and main_result.headers.get('error') %}
                                <p class="mb-0 mt-2">Error: {{ main_result.headers.error }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="content" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    {% set main_result = scan_results.results[scan_results.url] %}
                    {% if main_result.content_info and not main_result.content_info.get('error') %}
                        <h4 class="mb-3">Content Information</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-striped">
                                    <tr>
                                        <th>Title</th>
                                        <td>{{ main_result.content_info.title or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Content Type</th>
                                        <td>{{ main_result.content_info.content_type or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Content Length</th>
                                        <td>{{ main_result.content_info.content_length|default('N/A') }} bytes</td>
                                    </tr>
                                    <tr>
                                        <th>Status Code</th>
                                        <td>
                                            {% if main_result.content_info.status_code == 200 %}
                                                <span class="badge bg-success">{{ main_result.content_info.status_code }}</span>
                                            {% elif main_result.content_info.status_code >= 300 and main_result.content_info.status_code < 400 %}
                                                <span class="badge bg-info">{{ main_result.content_info.status_code }}</span>
                                            {% elif main_result.content_info.status_code >= 400 and main_result.content_info.status_code < 500 %}
                                                <span class="badge bg-warning">{{ main_result.content_info.status_code }}</span>
                                            {% elif main_result.content_info.status_code >= 500 %}
                                                <span class="badge bg-danger">{{ main_result.content_info.status_code }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ main_result.content_info.status_code|default('N/A') }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Internal Links</th>
                                        <td>{{ main_result.content_info.internal_links|default('N/A') }}</td>
                                    </tr>
                                    <tr>
                                        <th>External Links</th>
                                        <td>{{ main_result.content_info.external_links|default('N/A') }}</td>
                                    </tr>
                                    <tr>
                                        <th>Content Hash</th>
                                        <td><code>{{ main_result.content_info.content_hash[:20] or 'N/A' }}...</code></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5>JS Frameworks Detected</h5>
                                {% if main_result.content_info.js_frameworks %}
                                    <ul class="list-group">
                                        {% for framework in main_result.content_info.js_frameworks %}
                                            <li class="list-group-item">{{ framework }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p>No JavaScript frameworks detected</p>
                                {% endif %}
                                
                                <h5 class="mt-4">Meta Tags</h5>
                                {% if main_result.content_info.meta_tags %}
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Content</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for name, content in main_result.content_info.meta_tags.items() %}
                                                    <tr>
                                                        <td>{{ name }}</td>
                                                        <td>{{ content[:50] }}{% if content|length > 50 %}...{% endif %}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <p>No meta tags found</p>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Content information not available.
                            {% if main_result.content_info and main_result.content_info.get('error') %}
                                <p class="mb-0 mt-2">Error: {{ main_result.content_info.error }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="tech" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    {% set main_result = scan_results.results[scan_results.url] %}
                    {% if main_result and main_result.technology_stack %}
                        <h4 class="mb-3">Detected Technologies</h4>
                        <div class="row">
                            {% for category, technologies in main_result.technology_stack.items() %}
                                {% if technologies and category != 'versions' %}
                                    <div class="col-md-6 mb-3">
                                        <h5>{{ category|replace('_', ' ')|title }}</h5>
                                        <ul class="list-group">
                                            {% for tech in technologies %}
                                                <li class="list-group-item">
                                                    <i class="fas fa-check text-success"></i> {{ tech }}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        
                        {% if main_result.technology_stack.get('versions') %}
                            <h5 class="mt-4">Version Information</h5>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Version</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for component, version in main_result.technology_stack.versions.items() %}
                                        <tr>
                                            <td>{{ component }}</td>
                                            <td>{{ version }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No technology stack information detected.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="cookies" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    {% set main_result = scan_results.results[scan_results.url] %}
                    {% if main_result and main_result.cookie_security and main_result.cookie_security.cookies %}
                        <h4 class="mb-3">Cookie Security Analysis</h4>
                        
                        <div class="alert {% if main_result.cookie_security.security_score >= 80 %}alert-success{% elif main_result.cookie_security.security_score >= 50 %}alert-warning{% else %}alert-danger{% endif %} mb-4">
                            <h5>Security Score: {{ main_result.cookie_security.security_score }}%</h5>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Cookie Name</th>
                                        <th>Domain</th>
                                        <th>Secure</th>
                                        <th>HttpOnly</th>
                                        <th>SameSite</th>
                                        <th>Issues</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cookie in main_result.cookie_security.cookies %}
                                        <tr>
                                            <td><strong>{{ cookie.name }}</strong></td>
                                            <td>{{ cookie.domain or 'N/A' }}</td>
                                            <td>
                                                {% if cookie.secure %}
                                                    <i class="fas fa-check text-success"></i>
                                                {% else %}
                                                    <i class="fas fa-times text-danger"></i>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if cookie.httponly %}
                                                    <i class="fas fa-check text-success"></i>
                                                {% else %}
                                                    <i class="fas fa-times text-danger"></i>
                                                {% endif %}
                                            </td>
                                            <td>{{ cookie.samesite or 'Not set' }}</td>
                                            <td>
                                                {% if cookie.vulnerabilities %}
                                                    <span class="badge bg-danger">{{ cookie.vulnerabilities|length }}</span>
                                                {% else %}
                                                    <span class="badge bg-success">0</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No cookies found on this website.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="api" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    {% set has_api_data = false %}
                    {% for url, result in scan_results.results.items() %}
                        {% if result.api_endpoints and result.api_endpoints.endpoints_found %}
                            {% set has_api_data = true %}
                            <h4 class="mb-3">API Security Analysis</h4>
                            
                            <h5>Discovered Endpoints</h5>
                            <ul class="list-group mb-3">
                                {% for endpoint in result.api_endpoints.endpoints_found %}
                                    <li class="list-group-item">
                                        <i class="fas fa-link"></i> {{ endpoint }}
                                    </li>
                                {% endfor %}
                            </ul>
                            
                            {% if result.api_endpoints.documentation.found %}
                                <div class="alert alert-warning">
                                    <h5 class="alert-heading">API Documentation Exposed</h5>
                                    <p><strong>Type:</strong> {{ result.api_endpoints.documentation.type }}</p>
                                    <p><strong>URLs:</strong></p>
                                    <ul class="mb-0">
                                        {% for doc_url in result.api_endpoints.documentation.urls %}
                                            <li><a href="{{ doc_url }}" target="_blank">{{ doc_url }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            
                            {% if result.api_endpoints.vulnerabilities %}
                                <h5>API Vulnerabilities</h5>
                                {% for vuln in result.api_endpoints.vulnerabilities %}
                                    <div class="alert alert-{{ 'danger' if vuln.severity == 'High' or vuln.severity == 'Critical' else 'warning' if vuln.severity == 'Medium' else 'info' }} mb-2">
                                        <strong>{{ vuln.type }}</strong><br>
                                        <small>{{ vuln.description }}</small>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if not has_api_data %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No API endpoints detected on this website.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="whois" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    {% set main_result = scan_results.results[scan_results.url] %}
                    {% if main_result.whois_info and not main_result.whois_info.get('error') %}
                        <h4 class="mb-3">WHOIS Information</h4>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <tbody>
                                    {% for key, value in main_result.whois_info.items() %}
                                        <tr>
                                            <th>{{ key|title|replace('_', ' ') }}</th>
                                            <td>
                                                {% if value is string %}
                                                    {{ value }}
                                                {% elif value is mapping %}
                                                    <ul class="list-unstyled mb-0">
                                                        {% for subkey, subvalue in value.items() %}
                                                            <li><strong>{{ subkey }}:</strong> {{ subvalue }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% elif value is iterable and value is not mapping %}
                                                    <ul class="list-unstyled mb-0">
                                                        {% for item in value %}
                                                            <li>{{ item }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> WHOIS information not available.
                            {% if main_result.whois_info and main_result.whois_info.get('error') %}
                                <p class="mb-0 mt-2">Error: {{ main_result.whois_info.error }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="ip" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    {% set main_result = scan_results.results[scan_results.url] %}
                    {% if main_result.ip_quality_check and not main_result.ip_quality_check.get('error') %}
                        <h4 class="mb-3">IP Quality Score</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-striped">
                                    <tr>
                                        <th>IP Address</th>
                                        <td>{{ main_result.ip_quality_check.get('ip', 'N/A') }}</td>
                                    </tr>
                                    <tr>
                                        <th>Risk Score</th>
                                        <td>
                                            {% set risk_score = main_result.ip_quality_check.get('risk_score', 0) %}
                                            {% if risk_score < 25 %}
                                                <span class="badge bg-success">{{ risk_score }} - Low Risk</span>
                                            {% elif risk_score < 75 %}
                                                <span class="badge bg-warning">{{ risk_score }} - Medium Risk</span>
                                            {% else %}
                                                <span class="badge bg-danger">{{ risk_score }} - High Risk</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Country</th>
                                        <td>{{ main_result.ip_quality_check.get('country_code', 'N/A') }}</td>
                                    </tr>
                                    <tr>
                                        <th>ISP</th>
                                        <td>{{ main_result.ip_quality_check.get('ISP', 'N/A') }}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-striped">
                                    <tr>
                                        <th>Suspicious</th>
                                        <td>
                                            {% if main_result.ip_quality_check.get('suspicious', false) %}
                                                <span class="badge bg-danger">Yes</span>
                                            {% else %}
                                                <span class="badge bg-success">No</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Fraud Score</th>
                                        <td>{{ main_result.ip_quality_check.get('fraud_score', 'N/A') }}</td>
                                    </tr>
                                    <tr>
                                        <th>Domain Age</th>
                                        <td>{{ main_result.ip_quality_check.get('domain_age', {}).get('human', 'N/A') }}</td>
                                    </tr>
                                    <tr>
                                        <th>Domain Rank</th>
                                        <td>{{ main_result.ip_quality_check.get('domain_rank', 'N/A') }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> IP Quality Score information not available.
                            {% if main_result.ip_quality_check and main_result.ip_quality_check.get('error') %}
                                <p class="mb-0 mt-2">Error: {{ main_result.ip_quality_check.error }}</p>
                            {% endif %}
                            
                            {% if not config.get('ipqs_api_key') %}
                                <p class="mb-0 mt-2">
                                    <strong>IP Quality Score API key is not configured.</strong> 
                                    Go to <a href="{{ url_for('configure') }}">Settings</a> to add your API key.
                                </p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-4">
        <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg me-3">
            <i class="fas fa-home"></i> Back to Home
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg">
            <i class="fas fa-tachometer-alt"></i> Go to Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Pre-compute values for JavaScript 
    {% set main_result = scan_results.results[scan_results.url] %}
    
    // Pre-compute secure headers count
    {% set security_headers = ['Strict-Transport-Security', 'X-Content-Type-Options', 'X-Frame-Options', 
                               'Content-Security-Policy', 'X-XSS-Protection', 'Referrer-Policy',
                               'Feature-Policy', 'Permissions-Policy'] %}
    {% set secure_count = namespace(value=0) %}
    {% if main_result.headers %}
        {% for header in security_headers %}
            {% if header|lower in main_result.headers|string|lower %}
                {% set secure_count.value = secure_count.value + 1 %}
            {% endif %}
        {% endfor %}
    {% endif %}
    
    // Pre-compute vulnerability counts
    {% set high_vulns = namespace(count=0) %}
    {% set medium_vulns = namespace(count=0) %}
    {% set low_vulns = namespace(count=0) %}
    
    {% for url, result in scan_results.results.items() %}
        {% if result.vulnerabilities %}
            {% for vuln in result.vulnerabilities %}
                {% if vuln.severity|lower == 'high' %}
                    {% set high_vulns.count = high_vulns.count + 1 %}
                {% elif vuln.severity|lower == 'medium' %}
                    {% set medium_vulns.count = medium_vulns.count + 1 %}
                {% else %}
                    {% set low_vulns.count = low_vulns.count + 1 %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}
    
    // Pre-compute SSL score
    {% set ssl_base_score = 0 %}
    {% if main_result.ssl_info and not main_result.ssl_info.get('error') %}
        {% if not main_result.ssl_info.has_expired %}
            {% set ssl_base_score = 80 %}
            {% if 'Strict-Transport-Security' in main_result.headers %}
                {% set ssl_base_score = ssl_base_score + 20 %}
            {% endif %}
        {% endif %}
    {% endif %}
    
    // Pre-compute content and domain security scores
    {% set content_security_score = 40 %}
    {% if main_result.content_info and main_result.content_info.get('content_type') and 'text/html' in main_result.content_info.get('content_type') %}
        {% if main_result.headers and main_result.headers.get('Content-Security-Policy') %}
            {% set content_security_score = 85 %}
        {% endif %}
    {% else %}
        {% set content_security_score = 50 %}
    {% endif %}
    
    {% set domain_age_score = 50 %}
    {% if main_result.whois_info and main_result.whois_info.get('creation_date') %}
        {% set domain_age_score = 75 %}
    {% endif %}
    
    // Determine if vulnerabilities were found
    {% set vulnerabilities_found = scan_results.vulnerabilities_found %}
    
    // Security chart and analysis
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate security metrics
        let secureHeaders = {{ secure_count.value }};
        let totalHeaders = 8; // Common security headers to check
        
        let highVulns = {{ high_vulns.count }};
        let mediumVulns = {{ medium_vulns.count }};
        let lowVulns = {{ low_vulns.count }};
        
        // SSL score (0-100)
        let sslScore = {{ ssl_base_score }};
        
        const headerScore = (secureHeaders / totalHeaders) * 100;
        
        // Calculate overall risk score (lower is better)
        let riskScore = 0;
        riskScore += highVulns * 30;
        riskScore += mediumVulns * 15;
        riskScore += lowVulns * 5;
        
        if (headerScore < 50) {
            riskScore += 20;
        }
        
        if (sslScore < 50) {
            riskScore += 25;
        }
        
        let riskLabel = 'Low';
        let riskColor = '#4caf50';
        
        if (riskScore > 50) {
            riskLabel = 'High';
            riskColor = '#d32f2f';
        } else if (riskScore > 20) {
            riskLabel = 'Medium';
            riskColor = '#ff9800';
        }
        
        // Create the chart
        const ctx = document.getElementById('securityChart').getContext('2d');
        const securityChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['SSL Security', 'Security Headers', 'Vulnerability Score', 'Content Security', 'Domain Age'],
                datasets: [{
                    label: 'Security Score',
                    data: [
                        sslScore,
                        headerScore,
                        100 - Math.min(100, riskScore),
                        {{ content_security_score }},
                        {{ domain_age_score }}
                    ],
                    backgroundColor: 'rgba(76, 175, 80, 0.2)',
                    borderColor: '#4caf50',
                    pointBackgroundColor: '#2e7d32',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#2e7d32'
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: {
                            display: true
                        },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Add overall risk rating to the chart
        const chartContainer = document.getElementById('securityChart').parentNode;
        const riskRating = document.createElement('div');
        riskRating.classList.add('text-center', 'mt-3');
        riskRating.innerHTML = `<strong>Overall Risk Rating: <span style="color: ${riskColor}">${riskLabel}</span></strong>`;
        chartContainer.appendChild(riskRating);
    });
    
    // AI Analysis Feature
    document.addEventListener('DOMContentLoaded', function() {
        const enableAiButton = document.getElementById('enableAiButton');
        const runAiAnalysis = document.getElementById('runAiAnalysis');
        
        // Pre-determine if vulnerabilities were found
        const vulnerabilitiesFound = {{ 'true' if vulnerabilities_found else 'false' }};
        
        if (enableAiButton) {
            enableAiButton.addEventListener('click', function() {
                if (vulnerabilitiesFound) {
                    requestApiKey(function() {
                        runAnalysis();
                    });
                } else {
                    alert('No vulnerabilities were found to analyze. The AI feature works best when vulnerabilities are detected.');
                }
            });
        }
        
        if (runAiAnalysis) {
            runAiAnalysis.addEventListener('click', function() {
                if (vulnerabilitiesFound) {
                    runAnalysis();
                } else {
                    alert('No vulnerabilities were found to analyze. The AI feature works best when vulnerabilities are detected.');
                }
            });
        }
        
        function runAnalysis() {
            // Show loading indicator
            document.getElementById('aiFeatureInfo').classList.add('d-none');
            document.getElementById('aiAnalysisLoading').classList.remove('d-none');
            document.getElementById('aiAnalysisResult').classList.add('d-none');
            
            // Send request to analyze vulnerabilities
            $.ajax({
                url: '{{ url_for("api_analyze_vulnerabilities") }}',
                method: 'POST',
                data: {},
                success: function(response) {
                    // Hide loading indicator
                    document.getElementById('aiAnalysisLoading').classList.add('d-none');
                    
                    // Show result
                    const resultElement = document.getElementById('aiAnalysisResult');
                    resultElement.classList.remove('d-none');
                    resultElement.innerHTML = response.analysis.replace(/\n/g, '<br>');
                    
                    // Replace any headers (# Header) with styled headers
                    resultElement.innerHTML = resultElement.innerHTML.replace(
                        /<br>#+ (.*?)(<br>|$)/g, 
                        '<br><h4 class="mt-3">$1</h4>'
                    );
                    
                    // Highlight severity levels
                    resultElement.innerHTML = resultElement.innerHTML.replace(
                        /High Risk|Critical/g, 
                        '<span class="severity-high">$&</span>'
                    );
                    resultElement.innerHTML = resultElement.innerHTML.replace(
                        /Medium Risk/g, 
                        '<span class="severity-medium">$&</span>'
                    );
                    resultElement.innerHTML = resultElement.innerHTML.replace(
                        /Low Risk/g, 
                        '<span class="severity-low">$&</span>'
                    );
                    
                    // Style code blocks
                    resultElement.innerHTML = resultElement.innerHTML.replace(
                        /`([^`]+)`/g, 
                        '<code>$1</code>'
                    );
                },
                error: function(xhr) {
                    // Hide loading indicator and show info again
                    document.getElementById('aiAnalysisLoading').classList.add('d-none');
                    document.getElementById('aiFeatureInfo').classList.remove('d-none');
                    
                    const response = xhr.responseJSON || {};
                    
                    // If API key is needed, show the modal
                    if (response.need_api_key) {
                        requestApiKey(function() {
                            runAnalysis();
                        });
                    } else {
                        alert('Error: ' + (response.message || 'Failed to analyze vulnerabilities'));
                    }
                }
            });
        }
    });
</script>
{% endblock %}